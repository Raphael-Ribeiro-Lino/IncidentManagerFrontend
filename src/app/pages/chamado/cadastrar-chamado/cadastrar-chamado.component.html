<div class="page-container">
    <div class="content-card">
        <h1 class="section-title">Abrir Novo Chamado</h1>

        <div *ngIf="errorMessages.length" class="alert-box error">
            <div *ngFor="let msg of errorMessages; let i = index" class="alert-item">
                <span class="alert-msg">{{ msg }}</span>
                <button type="button" class="btn-close-alert" (click)="removeErrorIndex(i)">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>

        <div *ngIf="successfullyRegisteredChamado" class="alert-box success">
            {{ successfullyRegisteredChamado }}
        </div>

        <form [formGroup]="formChamado" class="standard-form" (ngSubmit)="submitForm()">

            <div class="form-row">
                <div class="form-col full">
                    <mat-form-field appearance="outline" class="full-width-field">
                        <mat-label>Título do Chamado</mat-label>
                        <input matInput formControlName="titulo" placeholder="Ex: Problema com o sistema X" />
                        <mat-error *ngIf="f['titulo'].hasError('required')">O título é obrigatório.</mat-error>
                        <mat-error *ngIf="f['titulo'].hasError('minlength')">Mínimo de 5 caracteres.</mat-error>
                        <mat-error *ngIf="f['titulo'].hasError('maxlength')">Máximo de 100 caracteres.</mat-error>
                    </mat-form-field>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col small">
                    <mat-form-field appearance="outline" class="full-width-field">
                        <mat-label>Prioridade</mat-label>
                        <mat-select formControlName="prioridade">
                            <mat-option value="">Selecione a Prioridade</mat-option>
                            <mat-option *ngFor="let p of prioridades" [value]="p"
                                [ngClass]="'prioridade-chip-' + p.toLowerCase()">
                                <span class="prioridade-option-label">
                                    <span [ngClass]="'prioridade-dot-' + p.toLowerCase()"></span>
                                    {{ p | lowercase | titlecase }}
                                </span>
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="f['prioridade'].hasError('required')">A prioridade é obrigatória.</mat-error>
                    </mat-form-field>
                </div>
                <div class="form-col small"></div>
            </div>

            <div class="form-row">
                <div class="form-col full">
                    <mat-form-field appearance="outline" class="full-width-field">
                        <mat-label>Descrição Detalhada</mat-label>
                        <textarea matInput formControlName="descricao" rows="5"
                            placeholder="Descreva o problema em detalhes..."></textarea>
                        <mat-error *ngIf="f['descricao'].hasError('required')">A descrição é obrigatória.</mat-error>
                        <mat-error *ngIf="f['descricao'].hasError('minlength')">Mínimo de 10 caracteres.</mat-error>
                        <mat-error *ngIf="f['descricao'].hasError('maxlength')">Máximo de 2000 caracteres.</mat-error>
                    </mat-form-field>
                </div>
            </div>

            <div class="form-row">
                <div class="form-col full drop-zone" [class.dragging]="isDragging" (drop)="onDrop($event)"
                    (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)">

                    <label class="label">Anexar Arquivos (Opcional)</label>

                    <div class="file-input-wrapper">
                        <input type="file" multiple class="hidden-file-input" (change)="onFileSelected($event)"
                            #fileInput />
                        <button type="button" class="btn btn-ghost file-upload-btn" (click)="fileInput.click()">
                            <mat-icon>attachment</mat-icon> Selecionar Arquivos
                        </button>
                        <span class="file-input-info" *ngIf="anexosSelecionados.length === 0">
                            Nenhum arquivo selecionado
                        </span>
                    </div>

                    <p class="text-muted small-text">
                        Formatos: PDF, DOCX, PNG, JPG, ZIP (Máx 50MB/arq • Total 500MB • Máx 20 arquivos)
                    </p>

                    <div class="storage-indicator" *ngIf="anexosSelecionados.length > 0">
                        <div class="storage-header">
                            <span class="storage-label">Armazenamento Utilizado</span>
                            <span class="storage-values">
                                <strong>{{ totalSizeUsed / 1024 / 1024 | number:'1.2-2' }} MB</strong>
                                / {{ maxTotalMB }} MB
                            </span>
                        </div>

                        <div class="progress-track">
                            <div class="progress-fill" [style.width.%]="percentageUsed"
                                [ngClass]="getProgressColorClass()">
                            </div>
                        </div>
                    </div>

                    <div *ngIf="anexosSelecionados.length > 0" class="anexos-chips-container">
                        <div *ngFor="let anexo of anexosSelecionados; let i = index" class="anexo-chip">
                            <mat-icon class="anexo-icon">{{ getFileIcon(anexo.tipo) }}</mat-icon>
                            <span class="anexo-info">
                                <span class="anexo-name" title="{{ anexo.nomeArquivo }}">
                                    {{ anexo.nomeArquivo | slice : 0 : 20 }}{{ anexo.nomeArquivo.length > 20 ? "..." : "" }}
                                </span>
                                <span class="anexo-size">({{ anexo.tamanhoBytes / 1024 / 1024 | number : "1.2-2" }} MB)</span>
                            </span>
                            <button type="button" class="btn-remove-chip" (click)="removeAnexo(i)">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <p class="text-muted small-text" style="margin-top: var(--space-sm);">* Campos obrigatórios</p>

            <div class="form-actions">
                <button class="btn btn-ghost" type="button" (click)="cancelar()">Cancelar</button>
                <button class="btn btn-primary" type="submit" [disabled]="formChamado.invalid || isLoading">
                    <span *ngIf="!isLoading">Abrir Chamado</span>
                    <span *ngIf="isLoading" class="spinner-container">
                        <span class="spinner"></span> Enviando...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>