<div class="chamado-list-page">
  <div class="page-header">
    <h1 class="page-title">Painel de Atendimentos</h1>
    <p class="page-subtitle">
      Gerencie seus chamados e solicitações em um só lugar.
    </p>
  </div>

  <!-- SISTEMA DE ABAS -->
  <mat-tab-group
    [(selectedIndex)]="selectedTabIndex"
      animationDuration="0ms" 
      class="custom-tabs" 
      mat-stretch-tabs="false" 
      mat-align-tabs="start">
  >
    <!-- ============================================= -->
    <!-- ABA 1: MEUS CHAMADOS -->
    <!-- ============================================= -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">assignment</mat-icon>
        Meus Atendimentos
        <!-- Badge do Contador na Aba -->
        <span class="tab-badge-grey" *ngIf="totalElementos > 0">{{
          totalElementos
        }}</span>
      </ng-template>

      <div class="tab-content">
        <div class="action-bar-container">
          <div class="filters-container">
            <div class="filter-inputs">
              <mat-form-field
                appearance="outline"
                class="search-field"
                subscriptSizing="dynamic"
              >
                <mat-label>Buscar Protocolo ou Título</mat-label>
                <input
                  matInput
                  [ngModel]="busca"
                  (ngModelChange)="onSearchInput($event)"
                  placeholder="Ex: Erro Impressora"
                />
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                class="priority-field"
                subscriptSizing="dynamic"
              >
                <mat-label>Prioridade</mat-label>
                <mat-select
                  [(ngModel)]="prioridadeSelecionada"
                  (selectionChange)="filtrar()"
                >
                  <mat-option value="">Todas</mat-option>
                  <mat-option value="BAIXA">Baixa</mat-option>
                  <mat-option value="MEDIA">Média</mat-option>
                  <mat-option value="ALTA">Alta</mat-option>
                  <mat-option value="CRITICA">Crítica</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <!-- Contador -->
          <div class="action-button">
            <mat-icon class="icon-small">list_alt</mat-icon>
            {{ totalElementos }} atendimentos
          </div>
        </div>

        <div class="loading-state" *ngIf="isLoading">
          <p>Carregando seus chamados...</p>
        </div>

        <div class="error-card" *ngIf="loadingFailed && !isLoading">
          <mat-icon class="error-icon">sentiment_dissatisfied</mat-icon>
          <div class="error-content">
            <h3>Ops! Algo deu errado.</h3>
            <p *ngFor="let msg of errorMessages">{{ msg }}</p>
            <button class="btn-error-retry" (click)="carregarChamados()">
              <mat-icon>refresh</mat-icon> Tentar Novamente
            </button>
          </div>
        </div>

        <div
          class="state-container"
          *ngIf="!isLoading && !loadingFailed && chamados.length === 0"
        >
          <mat-icon class="state-icon">
            {{
              busca || prioridadeSelecionada
                ? "filter_list_off"
                : "assignment_turned_in"
            }}
          </mat-icon>

          <h3>
            {{
              busca || prioridadeSelecionada
                ? "Nenhum resultado encontrado"
                : "Tudo limpo!"
            }}
          </h3>

          <p *ngIf="busca">
            Não encontramos chamados com o termo "<strong>{{ busca }}</strong
            >".
          </p>

          <p *ngIf="!busca && prioridadeSelecionada">
            Não há atendimentos com prioridade
            <strong>{{ prioridadeLabels[prioridadeSelecionada] }}</strong
            >.
          </p>

          <p *ngIf="!busca && !prioridadeSelecionada">
            Sua lista de trabalho está vazia. Bom trabalho!
          </p>
        </div>

        <!-- LISTA DE CARDS (COM TOOLTIPS ADICIONADOS) -->
        <div
          class="chamado-list-container"
          *ngIf="!isLoading && !loadingFailed && chamados.length > 0"
        >
          <div
            class="chamado-row priority-border-{{ c.prioridade | lowercase }}"
            *ngFor="let c of chamados"
          >
            <div class="row-main-content">
              <!-- Meta Dados -->
              <div class="row-header-meta">
                <div
                  class="protocolo-display"
                  matTooltip="Protocolo: {{ c.protocolo }}"
                >
                  <mat-icon class="icon-small">tag</mat-icon>
                  <strong>{{ c.protocolo }}</strong>
                </div>

                <div
                  class="date-time-display"
                  matTooltip="Última atualização: {{
                    c.dataUltimaAtualizacao | date : 'dd/MM/yyyy HH:mm'
                  }}"
                >
                  <mat-icon class="icon-small">update</mat-icon>
                  {{ c.dataUltimaAtualizacao | date : "dd/MM/yyyy HH:mm" }}
                </div>

                <div
                  class="mini-priority priority-text-{{
                    c.prioridade | lowercase
                  }}"
                  matTooltip="Prioridade: {{
                    prioridadeLabels[c.prioridade] || c.prioridade
                  }}"
                >
                  {{ prioridadeLabels[c.prioridade] || c.prioridade }}
                </div>

                <div
                  class="status-badge-inline status-{{ c.status | lowercase }}"
                  matTooltip="Status Atual: {{ c.status }}"
                >
                  {{ statusLabels[c.status] }}
                </div>
              </div>

              <!-- Título -->
              <h3 class="row-title" matTooltip="Título do chamado">
                {{ c.titulo }}
              </h3>

              <!-- Descrição -->
              <p class="row-description" matTooltip="Descrição do chamado">
                {{ c.descricao }}
              </p>

              <!-- Solicitante -->
              <div
                class="row-tech-info"
                matTooltip="Solicitante: {{ c.solicitante.nome }} ({{
                  c.solicitante.email
                }})"
              >
                <mat-icon class="icon-small">person</mat-icon> Solicitado por
                <strong>{{ c.solicitante.nome }}</strong>
              </div>
            </div>

            <!-- Ações -->
            <div class="row-actions-side">
              <div class="button-group">
                <button
                  class="btn-custom btn-details"
                  (click)="verDetalhes(c.id)"
                  matTooltip="Detalhes do chamado"
                >
                  <mat-icon>visibility</mat-icon> Detalhes
                </button>

                <button
                  class="btn-custom btn-yellow"
                  *ngIf="podeTransferir(c.status)"
                  (click)="abrirModalTransferencia(c)"
                  matTooltip="Solicitar transferência para outro técnico"
                >
                  <mat-icon>forward</mat-icon> Transferir
                </button>
              </div>
            </div>
          </div>
        </div>

        <div
          class="pagination-container"
          *ngIf="!isLoading && chamados.length > 0"
        >
          <app-pagination
            [pageNumber]="page"
            [totalPages]="totalPages"
            (pageChange)="paginar($event)"
          ></app-pagination>
        </div>
      </div>
    </mat-tab>

    <!-- ============================================= -->
    <!-- ABA 2: RECEBIDOS (Pendências) -->
    <!-- ============================================= -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon inbox-icon">move_to_inbox</mat-icon>
        Recebidos
        <span class="tab-badge-alert" *ngIf="pendenciasCount > 0">{{
          pendenciasCount
        }}</span>
      </ng-template>

      <div class="tab-content">
        <app-listar-transferencias-pendentes
          (listaAtualizada)="atualizarCountPendencias()"
        ></app-listar-transferencias-pendentes>
      </div>
    </mat-tab>

    <!-- ============================================= -->
    <!-- ABA 3: ENVIADOS (Histórico) -->
    <!-- ============================================= -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon outbox-icon">outbox</mat-icon>
        Enviados
        <span class="tab-badge-grey" *ngIf="enviadasCount > 0">
          {{ enviadasCount }}
        </span>
      </ng-template>

      <div class="tab-content">
        <app-listar-transferencias-enviadas
          (listaAtualizada)="atualizarCountEnviadas()"
        >
        </app-listar-transferencias-enviadas>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
