<div class="enviadas-container">
  <div class="action-bar-container">
    <div class="filters-container">
      <mat-form-field
        appearance="outline"
        class="search-field"
        subscriptSizing="dynamic"
      >
        <mat-label>Buscar no histórico...</mat-label>
        <input
          matInput
          [ngModel]="busca"
          (ngModelChange)="onSearchInput($event)"
          placeholder="Protocolo ou nome do técnico"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <div class="action-button">
      <mat-icon class="icon-small">outbox</mat-icon>
      {{ totalElementos }} enviadas
    </div>
  </div>

  <div class="loading-state" *ngIf="isLoading">
    <p>Carregando histórico...</p>
  </div>

  <div class="error-card" *ngIf="loadingFailed && !isLoading">
    <mat-icon class="error-icon">sentiment_dissatisfied</mat-icon>
    <div class="error-content">
      <h3>Ops! Algo deu errado.</h3>
      <p *ngFor="let msg of errorMessages">{{ msg }}</p>
      <button class="btn-error-retry" (click)="carregarEnviadas()">
        <mat-icon>refresh</mat-icon> Tentar Novamente
      </button>
    </div>
  </div>

  <div
    class="empty-state"
    *ngIf="!isLoading && !loadingFailed && transferencias.length === 0"
  >
    <ng-container *ngIf="busca; else semHistorico">
      <mat-icon class="empty-icon">search_off</mat-icon>
      <h3>Nenhum resultado encontrado</h3>
      <p>
        Não encontramos transferências com o termo "<strong>{{ busca }}</strong
        >".
      </p>
    </ng-container>

    <ng-template #semHistorico>
      <mat-icon class="empty-icon">history</mat-icon>
      <h3>Histórico vazio</h3>
      <p>Você ainda não solicitou nenhuma transferência.</p>
    </ng-template>
  </div>

  <div
    class="chamado-list-container"
    *ngIf="!isLoading && !loadingFailed && transferencias.length > 0"
  >
    <div
      class="chamado-row status-transfer-border-{{ t.status | lowercase }}"
      *ngFor="let t of transferencias"
    >
      <div class="row-main-content">
        <div class="row-header-meta">
          <div
            class="protocolo-display"
            matTooltip="Protocolo: {{ t.chamadoProtocolo }}"
          >
            <mat-icon class="icon-small">tag</mat-icon>
            <strong>{{ t.chamadoProtocolo }}</strong>
          </div>

          <div
            class="date-time-display"
            matTooltip="Solicitado em: {{
              t.dataSolicitacao | date : 'dd/MM/yyyy HH:mm'
            }}"
          >
            <mat-icon class="icon-small">event</mat-icon>
            <span>{{ t.dataSolicitacao | date : "dd/MM/yyyy" }}</span>
            <span class="time-part"
              >às {{ t.dataSolicitacao | date : "HH:mm" }}</span
            >
          </div>

          <div
            class="transfer-status-badge status-transfer-{{
              t.status | lowercase
            }}"
            matTooltip="Status atual da transferência"
          >
            {{ t.status }}
          </div>
        </div>

        <!-- Título (Sem link, apenas visualização) -->
        <h3
          class="row-title"
          matTooltip="Título do Chamado: {{ t.chamadoTitulo }}"
        >
          {{ t.chamadoTitulo }}
        </h3>

        <!-- Motivo -->
        <div class="row-reason-box" matTooltip="Motivo da Solicitação">
          <span class="reason-label">Motivo:</span> {{ t.motivo }}
        </div>

        <!-- Feedback da Resposta -->
        <div
          class="transfer-outcome-box outcome-{{ t.status | lowercase }}"
          *ngIf="t.status !== 'PENDENTE' && t.dataResposta"
          matTooltip="Detalhes da Resposta"
        >
          <ng-container *ngIf="t.status === 'ACEITA'">
            <mat-icon class="outcome-icon">check_circle</mat-icon>
            <div class="outcome-content">
              <span class="outcome-title">Solicitação Aceita</span>
              <span class="outcome-date"
                >Respondido em
                {{ t.dataResposta | date : "dd/MM/yyyy 'às' HH:mm" }}</span
              >
            </div>
          </ng-container>

          <ng-container *ngIf="t.status === 'RECUSADA'">
            <mat-icon class="outcome-icon">cancel</mat-icon>
            <div class="outcome-content">
              <span class="outcome-title">Solicitação Recusada</span>
              <span class="outcome-date"
                >Respondido em
                {{ t.dataResposta | date : "dd/MM/yyyy 'às' HH:mm" }}</span
              >
              <p class="outcome-reason">
                <strong>Motivo:</strong> {{ t.motivoRecusa }}
              </p>
            </div>
          </ng-container>

          <ng-container *ngIf="t.status === 'CANCELADA'">
            <mat-icon class="outcome-icon">block</mat-icon>
            <div class="outcome-content">
              <span class="outcome-title">Solicitação Cancelada</span>
              <span class="outcome-date"
                >Em {{ t.dataResposta | date : "dd/MM/yyyy 'às' HH:mm" }}</span
              >
              <p class="outcome-reason" *ngIf="t.motivoRecusa">
                {{ t.motivoRecusa }}
              </p>
            </div>
          </ng-container>
        </div>

        <!-- Destinatário -->
        <div class="row-tech-info" matTooltip="Enviado para este técnico">
          <mat-icon class="icon-small">forward</mat-icon>
          <span
            >Enviado para:
            <strong>{{ t.tecnicoDestinoNome || "Sistema" }}</strong></span
          >
        </div>
      </div>

      <!-- Ações -->
      <div class="row-actions-side">
        <div class="button-group">
          <button
            class="btn-custom btn-details"
            (click)="verChamado(t)"
            matTooltip="Dados do chamado"
          >
            <mat-icon>visibility</mat-icon> Detalhes
          </button>

          <button
            class="btn-custom btn-cancel"
            *ngIf="t.status === 'PENDENTE'"
            (click)="cancelar(t)"
            matTooltip="Cancelar envio e recuperar chamado"
          >
            <mat-icon>delete_forever</mat-icon> Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
    class="paginator-wrapper"
    *ngIf="!isLoading && !loadingFailed && totalElementos > 0"
  >
    <app-pagination
      [pageNumber]="page"
      [totalPages]="totalPages"
      (pageChange)="paginar($event)"
    ></app-pagination>
  </div>
</div>
