<div class="list-page-container">
  <div class="list-page-header">
    <h1 class="section-title">Usuários</h1>
    <p class="list-page-subtitle">
      Gerencie acessos, perfis e reenvio de convites
    </p>
  </div>

  <div *ngIf="successMessage" class="alert-box success">
    <div class="alert-item">
      <mat-icon class="alert-icon">check_circle</mat-icon>
      <span class="alert-msg">{{ successMessage }}</span>
    </div>
  </div>

  <div *ngIf="errorMessages.length" class="alert-box error">
    <div *ngFor="let msg of errorMessages" class="alert-item">
      <span class="alert-msg">{{ msg }}</span>
    </div>
  </div>

  <div class="list-action-bar">
    <div class="list-filters">
      <mat-form-field
        appearance="outline"
        class="filter-field-large"
        subscriptSizing="dynamic"
      >
        <mat-label>Buscar Nome ou E-mail</mat-label>
        <input
          matInput
          placeholder="Ex: João Silva"
          [(ngModel)]="searchTerm"
          (ngModelChange)="searchUsuarios($event)"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <mat-form-field
        appearance="outline"
        class="filter-field-small"
        subscriptSizing="dynamic"
      >
        <mat-label>Situação</mat-label>
        <mat-select
          [(ngModel)]="selectedAtivo"
          (selectionChange)="onFilterChange()"
        >
          <mat-option value="">Todos</mat-option>
          <mat-option value="true">Ativos</mat-option>
          <mat-option value="false">Inativos</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="action-button-wrapper">
      <button
        class="btn-action-primary"
        routerLink="/usuario/cadastrar"
        matTooltip="Cadastrar novo usuário"
      >
        <mat-icon>person_add</mat-icon>
        <span>Novo Usuário</span>
      </button>
    </div>
  </div>

  <div class="error-card" *ngIf="loadingFailed && !isLoading">
    <mat-icon class="error-icon">sentiment_dissatisfied</mat-icon>
    <div class="error-content">
      <h3>Ops! Algo deu errado.</h3>
      <p>
        Não foi possível carregar a lista de empresas. Verifique sua conexão ou
        tente novamente mais tarde.
      </p>
      <button class="btn-error-retry" (click)="carregarUsuarios(0)">
        <mat-icon>refresh</mat-icon> Tentar Novamente
      </button>
    </div>
  </div>

  <div
    class="list-cards-wrapper"
    *ngIf="!isLoading && !loadingFailed && usuarios.length > 0"
  >
    <div
      class="list-card-row company-card"
      *ngFor="let usuario of usuarios"
      [class.border-active]="usuario.ativo"
      [class.border-inactive]="!usuario.ativo"
    >
      <div class="company-avatar user-avatar" [class.inactive]="!usuario.ativo">
        <span>{{ usuario.nome.charAt(0) | uppercase }}</span>
      </div>

      <div class="card-content">
        <div class="company-header">
          <h3 class="card-title">{{ usuario.nome }}</h3>
          <span
            class="status-pill"
            [class.pill-success]="usuario.ativo"
            [class.pill-danger]="!usuario.ativo"
          >
            {{ usuario.ativo ? "Ativo" : "Inativo" }}
          </span>
        </div>

        <div class="company-details-grid">
          <div class="detail-item" matTooltip="E-mail">
            <mat-icon class="icon-tiny">email</mat-icon>
            <span class="truncate-text">{{ usuario.email }}</span>
          </div>

          <div class="detail-item" matTooltip="Perfil de Acesso">
            <mat-icon class="icon-tiny">badge</mat-icon>
            <span>{{ perfilLabels[usuario.perfil] || usuario.perfil }}</span>
          </div>

          <div
            class="detail-item"
            *ngIf="usuario.telefone"
            matTooltip="Telefone"
          >
            <mat-icon class="icon-tiny">phone</mat-icon>
            <span>{{ usuario.telefone }}</span>
          </div>

          <div class="detail-item" matTooltip="Empresa">
            <mat-icon class="icon-tiny">business</mat-icon>
            <span class="truncate-text">{{ usuario.empresa.nome }}</span>
          </div>
        </div>
      </div>

      <div class="card-actions-side">
        <div class="btn-group-vertical">
          <button
            class="btn-card-action"
            [routerLink]="['/usuario', usuario.id, 'editar']"
            matTooltip="Editar dados"
          >
            <mat-icon>edit</mat-icon> <span>Editar</span>
          </button>

          <button
            class="btn-card-action secondary"
            *ngIf="usuario.podeReenviarEmail"
            (click)="reenviarConvite(usuario)"
            matTooltip="Reenviar e-mail de definição de senha"
          >
            <mat-icon>send</mat-icon> <span>Reenviar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div
    class="state-container"
    *ngIf="!isLoading && !loadingFailed && usuarios.length === 0"
  >
    <mat-icon class="state-icon">person_off</mat-icon>
    <h3>
      {{
        searchTerm ? "Nenhum usuário encontrado" : "Nenhum usuário cadastrado"
      }}
    </h3>
    <p *ngIf="searchTerm">Não encontramos nada para "{{ searchTerm }}".</p>
    <p *ngIf="!searchTerm">Cadastre o primeiro usuário para começar.</p>
  </div>

  <div class="pagination-container" *ngIf="usuarios.length > 0 && !isLoading">
    <app-pagination
      [pageNumber]="currentPage"
      [totalPages]="totalPages"
      (pageChange)="carregarPagina($event)"
    >
    </app-pagination>
  </div>
</div>
